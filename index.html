<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Disponibilidad Semanal</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-neutral-50">
    <div id="root"></div>

    <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    // Configuración general
    const DAYS = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"]; // L a D
    const START_HOUR = 6;   // 06:00
    const END_HOUR = 23;    // 23:00

    const DEFAULT_NAMES = ["Ana", "Luis", "Carla", "Miguel", "Sofia", "Pedro"];

    // Utilidades de fechas (semana con inicio en Lunes)
    const toMidnight = (d)=>{const x=new Date(d); x.setHours(0,0,0,0); return x;};
    const startOfISOWeek = (d)=>{const x=toMidnight(d); const day=(x.getDay()+6)%7; // 0=lunes
      x.setDate(x.getDate()-day); return x;};
    const addDays = (d,n)=>{const x=new Date(d); x.setDate(x.getDate()+n); return x;};
    const addWeeks = (d,n)=>addDays(d, n*7);
    const isoKey = (d)=>{const x=toMidnight(d); return x.toISOString().slice(0,10);} // YYYY-MM-DD
    const monthNameEs = (d)=> new Intl.DateTimeFormat('es-ES',{month:'long'}).format(d);

    // Rango de horas
    const rangeHours = (start, end) => Array.from({length: end - start + 1}, (_, i) => i + start);
    const hourLabel = (h) => `${String(h).padStart(2, "0")}:00`;

    // Estructuras de datos
    const createEmptyAvailability = () => {
      const av = {};
      for (const d of DAYS) { av[d] = {}; for (let h = START_HOUR; h <= END_HOUR; h++) av[d][h] = false; }
      return av;
    };
    const createDefaultUsers = () => DEFAULT_NAMES.map((name, i) => ({ id: `u_${i}`, name, availability: createEmptyAvailability() }));

    // Persistencia por SEMANA (clave = lunes de la semana)
    const STORAGE_KEY = 'disponibilidad_semanal_v2';
    const loadAll = () => { try{ const raw=localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):{}; }catch{ return {}; } };
    const saveAll = (obj) => { localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); };

    const countToHsl = (count, max) => {
      const ratio = max === 0 ? 0 : count / max; // 0..1
      const hue = 120 * ratio; // 0 (rojo) → 120 (verde)
      const saturation = 80;
      const lightness = 92 - ratio * 35; // más oscuro con más disponibilidad
      return `hsl(${hue}deg ${saturation}% ${lightness}%)`;
    };

    const Btn = ({children, onClick, className=''}) => (
      <button onClick={onClick} className={`px-3 py-2 rounded-2xl shadow-sm border text-sm hover:shadow transition active:scale-[0.99] ${className}`}>{children}</button>
    );

    function App(){
      const HOURS = useMemo(() => rangeHours(START_HOUR, END_HOUR), []);

      // Semana visible
      const [weekStart, setWeekStart] = useState(() => startOfISOWeek(new Date()));
      const weekKey = isoKey(weekStart);

      // Estado global: mapa de semanas → usuarios
      const [weeksData, setWeeksData] = useState(() => {
        const all = loadAll();
        if (!all[weekKey]) all[weekKey] = createDefaultUsers();
        return all;
      });

      // Sincroniza en localStorage
      useEffect(() => { saveAll(weeksData); }, [weeksData]);

      // Usuarios de la semana activa
      const users = weeksData[weekKey] ?? createDefaultUsers();
      const [selectedUserId, setSelectedUserId] = useState(users[0]?.id ?? '');
      useEffect(()=>{ if(!weeksData[weekKey]) setWeeksData(prev=>({...prev,[weekKey]:createDefaultUsers()})); }, [weekKey]);

      const maxPeople = users.length;

      // Conteo global por celda
      const counts = useMemo(()=>{
        const map = {}; for (const day of DAYS){ map[day] = {}; for (const h of HOURS){ map[day][h] = users.reduce((acc,u)=> acc + (u.availability[day]?.[h]?1:0), 0); } }
        return map;
      }, [users]);

      const selectedUser = users.find(u=>u.id===selectedUserId) ?? users[0];

      // Mutadores: se escriben dentro de la semana actual
      const setUsersForWeek = (updUsers) => setWeeksData(prev => ({ ...prev, [weekKey]: updUsers }));

      const toggleCell = (day, hour) => {
        if(!selectedUser) return;
        const next = users.map(u => u.id!==selectedUser.id ? u : ({
          ...u,
          availability: { ...u.availability, [day]: { ...u.availability[day], [hour]: !u.availability[day][hour] } }
        }));
        setUsersForWeek(next);
      };

      const addUser = () => {
        const name = prompt('Nombre del nuevo usuario:');
        if(!name) return;
        setUsersForWeek([ ...users, { id:`u_${Date.now()}`, name, availability: createEmptyAvailability() } ]);
      };
      const renameUser = (id) => {
        const name = prompt('Nuevo nombre:');
        if(!name) return;
        setUsersForWeek(users.map(u=> u.id===id ? { ...u, name } : u));
      };
      const removeUser = (id) => {
        if(!confirm('¿Eliminar este usuario?')) return;
        const next = users.filter(u=>u.id!==id);
        setUsersForWeek(next);
        if(selectedUserId===id && next[0]) setSelectedUserId(next[0].id);
      };

      const exportJSON = () => {
        const dataStr = JSON.stringify(weeksData);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'disponibilidad_semanal.json'; a.click(); URL.revokeObjectURL(url);
      };

      const importJSON = async () => {
        const text = prompt('Pega aquí el JSON exportado:');
        if(!text) return;
        try{ const parsed = JSON.parse(text); setWeeksData(parsed); alert('Datos importados'); }
        catch(e){ alert('No se pudo importar: '+ e.message); }
      };

      const goPrevWeek = () => setWeekStart(prev => addWeeks(prev, -1));
      const goNextWeek = () => setWeekStart(prev => addWeeks(prev, 1));

      // Encabezados con día y fecha (ej. Lun 2)
      const headers = DAYS.map((d, idx) => {
        const date = addDays(weekStart, idx);
        return { day: d, date, label: `${d} ${date.getDate()}` };
      });

      return (
        <div className="min-h-screen bg-neutral-50 text-neutral-900">
          {/* Header */}
          <header className="sticky top-0 z-20 bg-white/80 backdrop-blur border-b">
            <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-9 h-9 rounded-2xl bg-emerald-600" />
                <div>
                  <h1 className="text-lg font-semibold">Disponibilidad semanal</h1>
                  <p className="text-xs text-neutral-500">Semana del {weekStart.getDate()} de {monthNameEs(weekStart)}</p>
                </div>
              </div>
              <div className="flex items-center gap-2">
                {/* Botón A = Agregar/editar (abre panel de usuarios) */}
                <Btn onClick={()=>alert('Selecciona tu usuario y marca celdas en la grilla.')} className="bg-white border-neutral-200">A</Btn>
                <Btn onClick={()=>setShowUsersPanel(s=>!s)} className="bg-white border-neutral-200">Usuarios</Btn>
                <Btn onClick={exportJSON} className="bg-white border-neutral-200">Exportar</Btn>
                <Btn onClick={importJSON} className="bg-white border-neutral-200">Importar</Btn>
              </div>
            </div>
          </header>

          {/* Barra de navegación por semanas */}
          <div className="max-w-7xl mx-auto px-4 mt-4">
            <div className="flex items-center gap-2 p-3 bg-white rounded-2xl shadow-sm border">
              <Btn onClick={goPrevWeek} className="bg-white border-neutral-200">◀ Semana</Btn>
              <div className="text-sm text-neutral-700 font-medium">
                {`Semana de ${weekStart.getDate()} ${monthNameEs(weekStart)} (${isoKey(weekStart)})`}
              </div>
              <Btn onClick={goNextWeek} className="bg-white border-neutral-200 ml-auto">Semana ▶</Btn>
            </div>
          </div>

          {/* Selector rápido de usuario activo */}
          <div className="max-w-7xl mx-auto px-4 mt-3">
            <div className="flex items-center gap-2 flex-wrap">
              <span className="text-sm text-neutral-600">Usuario activo:</span>
              {users.map(u => (
                <button key={u.id} onClick={()=>setSelectedUserId(u.id)}
                        className={`text-sm px-2.5 py-1 rounded-xl border ${u.id===selectedUserId? 'bg-emerald-600 text-white border-emerald-700':'bg-white border-neutral-200'}`}>{u.name}</button>
              ))}
              <Btn onClick={addUser} className="bg-white border-neutral-200">Añadir</Btn>
            </div>
          </div>

          {/* Tabla principal */}
          <main className="max-w-7xl mx-auto px-4 py-4">
            <div className="rounded-2xl border bg-white shadow-sm overflow-hidden">
              <div className="grid" style={{ gridTemplateColumns: `150px repeat(${DAYS.length}, 1fr)` }}>
                <div className="sticky left-0 z-10 bg-white/80 backdrop-blur p-3 border-b font-medium">Hora</div>
                {headers.map(h => (
                  <div key={h.label} className="p-3 border-b text-center font-medium">{h.label}</div>
                ))}
              </div>

              <div className="max-h-[70vh] overflow-auto">
                {HOURS.map(h => (
                  <div key={h} className="grid" style={{ gridTemplateColumns: `150px repeat(${DAYS.length}, 1fr)` }}>
                    <div className="sticky left-0 z-10 bg-white/80 backdrop-blur p-3 border-b text-sm text-neutral-600">{hourLabel(h)}</div>
                    {DAYS.map(day => {
                      const c = counts[day][h];
                      const bg = countToHsl(c, maxPeople);
                      const isSelected = selectedUser?.availability[day]?.[h] ?? false;
                      return (
                        <button key={day} onClick={()=>toggleCell(day,h)} className="relative h-12 border-b border-l focus:outline-none" style={{ background: bg }} title={`Disponibles: ${c}/${maxPeople}`}>
                          <span className="absolute top-1 right-1 text-[10px] font-semibold text-neutral-700/80">{c}</span>
                          <span className={`inline-block text-base ${isSelected? 'opacity-100':'opacity-0'}`}>●</span>
                        </button>
                      );
                    })}
                  </div>
                ))}
              </div>
            </div>

            {/* Leyenda */}
            <div className="mt-4 flex items-center gap-3 text-sm text-neutral-600">
              <div className="flex items-center gap-2"><div className="w-5 h-4 rounded" style={{ background: countToHsl(0, maxPeople) }}></div><span>0 disponibles</span></div>
              <div className="flex items-center gap-2"><div className="w-5 h-4 rounded" style={{ background: countToHsl(Math.round(maxPeople/2), maxPeople) }}></div><span>~{Math.round(maxPeople/2)} disponibles</span></div>
              <div className="flex items-center gap-2"><div className="w-5 h-4 rounded" style={{ background: countToHsl(maxPeople, maxPeople) }}></div><span>{maxPeople} disponibles</span></div>
              <div className="ml-auto text-xs">El punto negro "●" indica tu propia disponibilidad</div>
            </div>
          </main>

          {/* Panel lateral de usuarios (abre con botón Usuarios o A) */}
          { (true) && (
            <div className={`fixed inset-0 z-30 ${false? '':'hidden'}`}></div>
          )}

          {/* Diálogo de usuarios */}
          {showUsersPanel && (
            <div className="fixed inset-0 z-30">
              <div className="absolute inset-0 bg-black/30" onClick={()=>setShowUsersPanel(false)}></div>
              <aside className="absolute right-0 top-0 h-full w-full sm:w-[380px] bg-white shadow-xl p-4 overflow-auto">
                <div className="flex items-center justify-between mb-3">
                  <h2 className="text-base font-semibold">Usuarios</h2>
                  <Btn onClick={()=>setShowUsersPanel(false)} className="bg-white">Cerrar</Btn>
                </div>
                <div className="space-y-2">
                  {users.map(u => (
                    <div key={u.id} className={`p-3 rounded-2xl border flex items-center justify-between ${u.id===selectedUserId? 'border-emerald-300 bg-emerald-50':'border-neutral-200 bg-white'}`}>
                      <div className="flex items-center gap-3">
                        <input type="radio" name="user" checked={u.id===selectedUserId} onChange={()=>setSelectedUserId(u.id)} />
                        <span className="font-medium">{u.name}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <Btn onClick={()=>renameUser(u.id)} className="text-xs">Renombrar</Btn>
                        <Btn onClick={()=>removeUser(u.id)} className="text-xs text-rose-700 border-rose-200">Eliminar</Btn>
                      </div>
                    </div>
                  ))}
                </div>
              </aside>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
  </body>
</html>
