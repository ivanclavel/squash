<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Disponibilidad Semanal</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <style>
    @media (max-width: 640px) {
      .cell { height: 2.25rem; } /* más compacto en móvil */
    }
  </style>
</head>
<body class="bg-neutral-50">
  <div id="root" class="p-4 text-neutral-800">Cargando…</div>

  <script type="text/babel" data-presets="env,react">
    const { useState, useMemo, useEffect } = React;

    // === Firebase (tu config) ===
    const firebaseConfig = {
      apiKey: "AIzaSyCYLq1D0dXYUq7R3ZEii35DvcxcxliiTzc",
      authDomain: "disponibilidad-semanal-a6d69.firebaseapp.com",
      projectId: "disponibilidad-semanal-a6d69",
      storageBucket: "disponibilidad-semanal-a6d69.appspot.com",
      messagingSenderId: "542880259657",
      appId: "1:542880259657:web:a3f7f76cd33826de5fe998",
      measurementId: "G-ZMRJKBDJT6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    // ============================

    const DAYS = ["Lunes","Martes","Miércoles","Jueves","Viernes","Sábado","Domingo"];
    const START_HOUR = 6, END_HOUR = 23;
    const DEFAULT_USERS = ["Fernando","Christian","David","Gustavo","Luis","Walter","Wilson","Ivan"];

    const toMidnight = d => { const x=new Date(d); x.setHours(0,0,0,0); return x; };
    const startOfWeek = d => { const x=toMidnight(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); return x; };
    const addDays = (d,n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x; };
    const addWeeks = (d,n) => addDays(d, n*7);
    const isoKey = d => toMidnight(d).toISOString().slice(0,10);
    const monthNameEs = d => new Intl.DateTimeFormat('es-ES',{month:'long'}).format(d);

    const rangeHours = (s,e) => Array.from({length:e-s+1}, (_,i)=>i+s);
    const hourLabel = h => `${String(h).padStart(2,"0")}:00`;

    const createEmpty = () => {
      const av={}; for (const d of DAYS){ av[d]={}; for(let h=START_HOUR; h<=END_HOUR; h++) av[d][h]=false; }
      return av;
    };
    const makeId = name => 'u_'+name.toLowerCase();
    const createUsers = () => DEFAULT_USERS.map(n=>({ id:makeId(n), name:n, availability:createEmpty() }));

    const mergeDefaultUsers = incoming => {
      const byName = Object.fromEntries((incoming||[]).map(u=>[u.name,u]));
      return DEFAULT_USERS.map(n => byName[n] ? byName[n] : { id:makeId(n), name:n, availability:createEmpty() });
    };

    const countToHsl = (count,max) => {
      const ratio=max===0?0:count/max;
      const hue=120*ratio, saturation=80, lightness=92-ratio*35;
      return `hsl(${hue}deg ${saturation}% ${lightness}%)`;
    };

    const Btn = ({children,onClick,className="",disabled=false}) => (
      <button onClick={onClick} disabled={disabled}
        className={"px-3 py-2 rounded-xl border text-sm hover:shadow transition disabled:opacity-60 "+className}>
        {children}
      </button>
    );

    function App(){
      const HOURS = useMemo(()=>rangeHours(START_HOUR,END_HOUR),[]);
      const [weekStart,setWeekStart] = useState(()=>startOfWeek(new Date())); // semana actual
      const weekKey = isoKey(weekStart);

      const [users,setUsers] = useState(createUsers());
      const [activeId,setActiveId] = useState(makeId(DEFAULT_USERS[0]));
      const [loading,setLoading] = useState(true);
      const [saving,setSaving] = useState(false);
      const [message,setMessage] = useState("");

      // Suscripción a Firestore
      useEffect(()=>{
        let unsub=null;
        setLoading(true);
        const docRef = db.collection("disponibilidad").doc(weekKey);
        unsub = docRef.onSnapshot(snap=>{
          if (snap.exists) {
            const merged = mergeDefaultUsers(snap.data().users || []);
            setUsers(merged);
            if (!merged.find(u=>u.id===activeId)) setActiveId(merged[0]?.id);
          } else {
            const initial = createUsers();
            docRef.set({ users: initial, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
            setUsers(initial);
          }
          setLoading(false);
        }, err=>{
          console.error(err);
          setMessage("No se pudo cargar desde el servidor.");
          setLoading(false);
        });
        return ()=>unsub && unsub();
      }, [weekKey]);

      const activeUser = users.find(u=>u.id===activeId) || users[0];

      const toggleCell = (d,h) => {
        if (!activeUser) return;
        setUsers(prev => prev.map(u => u.id!==activeUser.id ? u : ({
          ...u,
          availability: { ...u.availability, [d]: { ...u.availability[d], [h]: !u.availability[d][h] } }
        })));
      };

      const counts = useMemo(()=>{
        const map={}; for(const d of DAYS){ map[d]={}; for(const h of HOURS){ map[d][h]=users.reduce((a,u)=>a+(u.availability[d][h]?1:0),0);} }
        return map;
      },[users]);

      const saveToCloud = async () => {
        setSaving(true); setMessage("");
        try {
          const docRef = db.collection("disponibilidad").doc(weekKey);
          await docRef.set({ users: mergeDefaultUsers(users), updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
          setMessage("Guardado OK");
          setTimeout(()=>setMessage(""), 2000);
        } catch(e){ console.error(e); setMessage("Error al guardar."); }
        finally { setSaving(false); }
      };

      const headers = DAYS.map((d,i)=>`${d} ${addDays(weekStart,i).getDate()}`);
      const maxPeople = users.length;

      // === LAYOUT con un solo contenedor con overflow ===
      return (
        <div className="min-h-screen">
          <header className="bg-white/80 backdrop-blur border-b px-3 py-3 flex flex-col sm:flex-row sm:items-center gap-2 justify-between sticky top-0 z-40">
            <div>
              <h1 className="font-semibold text-lg">Disponibilidad semanal</h1>
              <p className="text-xs text-neutral-500">Semana del {weekStart.getDate()} de {new Intl.DateTimeFormat('es-ES',{month:'long'}).format(weekStart)}</p>
            </div>
            <div className="flex items-center gap-2">
              <Btn onClick={()=>setWeekStart(prev=>addWeeks(prev,-1))}>◀ Semana</Btn>
              <Btn onClick={()=>setWeekStart(prev=>addWeeks(prev,1))}>Semana ▶</Btn>
              <Btn onClick={saveToCloud} disabled={saving} className="bg-emerald-600 text-white border-emerald-700">
                {saving? "Guardando..." : "Salvar"}
              </Btn>
            </div>
          </header>

          <div className="px-3 mt-2 text-sm text-amber-700">{message}</div>

          <div className="px-3 mt-3">
            <div className="flex items-center gap-2 overflow-auto pb-2">
              <span className="text-sm text-neutral-600">Usuario activo:</span>
              {users.map(u=>(
                <button key={u.id}
                        onClick={()=>setActiveId(u.id)}
                        className={"text-sm px-2.5 py-1 rounded-md border whitespace-nowrap "+(u.id===activeId?"bg-emerald-600 text-white border-emerald-700":"bg-white border-neutral-200")}>
                  {u.name}
                </button>
              ))}
            </div>
          </div>

          {/* UN SOLO SCROLL WRAPPER para encabezado + filas */}
          <main className="px-3 py-3">
            <div className="rounded-xl border bg-white shadow">
              <div className="relative max-h-[70vh] overflow-auto">

                {/* Fila de encabezados (sticky top dentro del MISMO contenedor) */}
                <div className="grid sticky top-0 z-30"
                     style={{gridTemplateColumns:`120px repeat(${DAYS.length}, minmax(110px,1fr))`}}>
                  {/* Celda esquina: sticky top + left, arriba de todo */}
                  <div className="p-2 font-medium border-b bg-gray-50 sticky left-0 z-40">Hora</div>
                  {headers.map(h=>(
                    <div key={h} className="p-2 font-medium border-b text-center bg-gray-50">{h}</div>
                  ))}
                </div>

                {/* Filas (comparten el MISMO contenedor; la columna Hora es sticky left) */}
                {HOURS.map(h=>(
                  <div key={h} className="grid"
                       style={{gridTemplateColumns:`120px repeat(${DAYS.length}, minmax(110px,1fr))`}}>
                    <div className="p-2 border-b text-xs sm:text-sm text-neutral-600 bg-white sticky left-0 z-20">
                      {hourLabel(h)}
                    </div>
                    {DAYS.map(d=>{
                      const c = counts[d][h];
                      const isMe = (users.find(u=>u.id===activeId)?.availability[d][h]) || false;
                      return (
                        <button key={d}
                                onClick={()=>toggleCell(d,h)}
                                className="cell relative h-10 sm:h-12 border-b border-l focus:outline-none"
                                style={{background: countToHsl(c, maxPeople)}}
                                title={`Disponibles: ${c}/${maxPeople}`}>
                          <span className="absolute top-1 right-1 text-[10px] font-bold text-neutral-700/80">{c}</span>
                          {isMe && <span className="inline-block text-base">●</span>}
                        </button>
                      );
                    })}
                  </div>
                ))}

              </div>
            </div>
            <div className="mt-3 text-xs text-neutral-500">● indica tu propia disponibilidad</div>
          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>