<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Disponibilidad Semanal</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <style>
    @media (max-width: 640px) {
      .cell { height: 2.25rem; }
      .hour-col { position: sticky; left: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(4px); }
      .grid-wrapper { overflow-x: auto; }
      .header-sticky { position: sticky; top: 0; z-index: 10; }
    }
  </style>
</head>
<body class="bg-neutral-50">
  <div id="root" class="p-4 text-neutral-800">Cargando…</div>

  <script type="text/babel" data-presets="env,react">
    const { useState, useMemo, useEffect } = React;

    // ========= CONFIGURACIÓN FIREBASE =========
    const firebaseConfig = {
      apiKey: "AIzaSyCYLq1D0dXYUq7R3ZEii35DvcxcxliiTzc",
      authDomain: "disponibilidad-semanal-a6d69.firebaseapp.com",
      projectId: "disponibilidad-semanal-a6d69",
      storageBucket: "disponibilidad-semanal-a6d69.appspot.com",
      messagingSenderId: "542880259657",
      appId: "1:542880259657:web:a3f7f76cd33826de5fe998",
      measurementId: "G-ZMRJKBDJT6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    // ==========================================

    const DAYS = ["Lunes","Martes","Miércoles","Jueves","Viernes","Sábado","Domingo"];
    const START_HOUR = 6, END_HOUR = 23;

    // Incluye a Ivan
    const DEFAULT_USERS = ["Fernando","Christian","David","Gustavo","Luis","Walter","Wilson","Ivan"];

    // Helpers de semana (muestra la semana actual por defecto)
    const toMidnight = d => { const x=new Date(d); x.setHours(0,0,0,0); return x; };
    const startOfWeek = d => { const x=toMidnight(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); return x; }; // lunes
    const addDays = (d,n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x; };
    const addWeeks = (d,n) => addDays(d, n*7);
    const isoKey = d => toMidnight(d).toISOString().slice(0,10);
    const monthNameEs = d => new Intl.DateTimeFormat('es-ES',{month:'long'}).format(d);

    // Horas y etiquetas
    const rangeHours = (s,e) => Array.from({length:e-s+1}, (_,i)=>i+s);
    const hourLabel = h => `${String(h).padStart(2,"0")}:00`;

    // Estructuras
    const createEmpty = () => {
      const av={};
      for(const d of DAYS){ av[d]={}; for(let h=START_HOUR;h<=END_HOUR;h++) av[d][h]=false; }
      return av;
    };
    const makeId = (name) => 'u_' + name.toLowerCase();
    const createUsers = () => DEFAULT_USERS.map(name => ({ id: makeId(name), name, availability: createEmpty() }));

    // FUSIÓN: toma usuarios del servidor y garantiza que estén los DEFAULT_USERS (añade los que falten, como Ivan)
    const mergeDefaultUsers = (incoming) => {
      const byName = Object.fromEntries((incoming||[]).map(u => [u.name, u]));
      const merged = DEFAULT_USERS.map(name => {
        return byName[name] ? byName[name] : { id: makeId(name), name, availability: createEmpty() };
      });
      return merged;
    };

    // Color por cantidad
    const countToHsl = (count,max) => {
      const ratio=max===0?0:count/max;
      const hue=120*ratio;  // rojo→verde
      const saturation=80;
      const lightness=92-ratio*35;
      return `hsl(${hue}deg ${saturation}% ${lightness}%)`;
    };

    const Btn = ({children, onClick, className="", disabled=false}) => (
      <button onClick={onClick} disabled={disabled}
        className={"px-3 py-2 rounded-xl border text-sm hover:shadow transition disabled:opacity-60 disabled:cursor-not-allowed "+className}>
        {children}
      </button>
    );

    function App(){
      const HOURS = useMemo(()=>rangeHours(START_HOUR,END_HOUR),[]);

      // Semana actual por defecto
      const [weekStart,setWeekStart] = useState(()=>startOfWeek(new Date()));
      const weekKey = isoKey(weekStart);

      const [users,setUsers] = useState(createUsers());
      const [activeId,setActiveId] = useState(makeId(DEFAULT_USERS[0]));
      const [loading,setLoading] = useState(true);
      const [saving,setSaving] = useState(false);
      const [message,setMessage] = useState("");

      // Suscripción a Firestore por semana (con fusión para no perder usuarios nuevos)
      useEffect(()=>{
        let unsub = null;
        setLoading(true); setMessage("");
        const docRef = db.collection("disponibilidad").doc(weekKey);

        unsub = docRef.onSnapshot((snap)=>{
          if (snap.exists) {
            const data = snap.data();
            // Mezcla lo que hay en la nube con la lista por defecto (añade Ivan si falta)
            const merged = mergeDefaultUsers(Array.isArray(data.users) ? data.users : []);
            setUsers(merged);
            // Garantiza que activeId apunte a uno válido
            if (!merged.find(u => u.id === activeId)) setActiveId(merged[0]?.id);
          } else {
            const initial = createUsers();
            docRef.set({ users: initial, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
            setUsers(initial);
          }
          setLoading(false);
        }, (err)=>{
          console.error(err);
          setMessage("No se pudo cargar desde el servidor.");
          setLoading(false);
        });
        return ()=>{ if (unsub) unsub(); };
      }, [weekKey]);

      const activeUser = users.find(u=>u.id===activeId) || users[0];

      const toggleCell = (d,h) => {
        if (!activeUser) return;
        setUsers(prev => prev.map(u => u.id!==activeUser.id ? u : ({
          ...u,
          availability: { ...u.availability, [d]: { ...u.availability[d], [h]: !u.availability[d][h] } }
        })));
      };

      const counts = useMemo(()=>{
        const map={}; for(const d of DAYS){ map[d]={}; for(const h of HOURS){ map[d][h]=users.reduce((a,u)=>a+(u.availability[d][h]?1:0),0);} }
        return map;
      },[users]);

      const saveToCloud = async () => {
        setSaving(true); setMessage("");
        try {
          // Siempre guardamos la versión fusionada para que quede persistente con Ivan incluido
          const toSave = mergeDefaultUsers(users);
          const docRef = db.collection("disponibilidad").doc(weekKey);
          await docRef.set(
            { users: toSave, updatedAt: firebase.firestore.FieldValue.serverTimestamp() },
            { merge:true }
          );
          setMessage("Guardado OK");
          setTimeout(()=>setMessage(""), 2000);
        } catch (e) {
          console.error(e);
          setMessage("Error al guardar.");
        } finally {
          setSaving(false);
        }
      };

      const headers = DAYS.map((d,i)=>`${d} ${addDays(weekStart,i).getDate()}`);
      const maxPeople = users.length;

      return (
        <div className="min-h-screen">
          <header className="header-sticky bg-white/80 backdrop-blur border-b px-3 py-3 flex flex-col sm:flex-row sm:items-center gap-2 justify-between">
            <div>
              <h1 className="font-semibold text-lg">Disponibilidad semanal</h1>
              <p className="text-xs text-neutral-500">Semana del {weekStart.getDate()} de {monthNameEs(weekStart)}</p>
            </div>
            <div className="flex items-center gap-2">
              <Btn onClick={()=>setWeekStart(prev=>addWeeks(prev,-1))}>◀ Semana</Btn>
              <Btn onClick={()=>setWeekStart(prev=>addWeeks(prev,1))}>Semana ▶</Btn>
              <Btn onClick={saveToCloud} disabled={saving} className="bg-emerald-600 text-white border-emerald-700">
                {saving? "Guardando..." : "Salvar"}
              </Btn>
            </div>
          </header>

          <div className="px-3 mt-2 text-sm text-amber-700">{message}</div>

          <div className="px-3 mt-3">
            <div className="flex items-center gap-2 overflow-auto pb-2">
              <span className="text-sm text-neutral-600">Usuario activo:</span>
              {users.map(u => (
                <button key={u.id}
                  onClick={()=>setActiveId(u.id)}
                  className={"text-sm px-2.5 py-1 rounded-md border "+(u.id===activeId?"bg-emerald-600 text-white border-emerald-700":"bg-white border-neutral-200")}>
                  {u.name}
                </button>
              ))}
            </div>
          </div>

          <main className="px-3 py-3">
            <div className="rounded-xl border bg-white shadow grid-wrapper">
              <div className="grid" style={{gridTemplateColumns:`100px repeat(${DAYS.length}, minmax(90px,1fr))`}}>
                <div className="p-2 font-medium border-b bg-gray-50 hour-col">Hora</div>
                {headers.map(h => <div key={h} className="p-2 font-medium border-b text-center bg-gray-50">{h}</div>)}
              </div>

              <div className="max-h-[70vh] overflow-auto">
                {loading ? (
                  <div className="p-4 text-sm text-neutral-600">Cargando datos…</div>
                ) : (
                  rangeHours(START_HOUR, END_HOUR).map(h => (
                    <div key={h} className="grid" style={{gridTemplateColumns:`100px repeat(${DAYS.length}, minmax(90px,1fr))`}}>
                      <div className="p-2 border-b text-xs sm:text-sm text-neutral-600 bg-gray-50 hour-col">{hourLabel(h)}</div>
                      {DAYS.map(d => {
                        const c = counts[d][h];
                        const isMe = activeUser?.availability[d][h] || false;
                        return (
                          <button key={d}
                            onClick={()=>toggleCell(d,h)}
                            className="cell relative h-10 sm:h-12 border-b border-l"
                            style={{background: countToHsl(c, maxPeople)}}
                            title={`Disponibles: ${c}/${maxPeople}`}>
                            <span className="absolute top-1 right-1 text-[10px] font-bold text-neutral-700/80">{c}</span>
                            {isMe && <span className="inline-block text-base">●</span>}
                          </button>
                        );
                      })}
                    </div>
                  ))
                )}
              </div>
            </div>
            <div className="mt-3 text-xs text-neutral-500">● indica tu propia disponibilidad</div>
          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>